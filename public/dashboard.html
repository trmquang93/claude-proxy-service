<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dashboard - Claude Proxy Service</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f5f5;
            min-height: 100vh;
        }
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header-content {
            max-width: 1200px;
            margin: 0 auto;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .container {
            max-width: 1200px;
            margin: 40px auto;
            padding: 0 20px;
        }
        .card {
            background: white;
            border-radius: 12px;
            padding: 30px;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
        }
        h1 {
            font-size: 24px;
        }
        h2 {
            color: #333;
            margin-bottom: 20px;
            font-size: 20px;
        }
        .status {
            display: inline-block;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 14px;
            font-weight: 500;
        }
        .status.connected {
            background: #e8f5e9;
            color: #2e7d32;
        }
        .status.disconnected {
            background: #ffebee;
            color: #c62828;
        }
        button {
            padding: 12px 24px;
            border: none;
            border-radius: 6px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }
        .btn-primary {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
        }
        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4);
        }
        .btn-danger {
            background: #e53935;
            color: white;
        }
        .btn-secondary {
            background: #f5f5f5;
            color: #333;
        }
        .btn-logout {
            background: rgba(255,255,255,0.2);
            color: white;
            padding: 8px 16px;
        }
        .message {
            padding: 12px;
            border-radius: 6px;
            margin-bottom: 20px;
            display: none;
        }
        .message.error {
            background: #fee;
            color: #c33;
            border: 1px solid #fcc;
        }
        .message.success {
            background: #efe;
            color: #3c3;
            border: 1px solid #cfc;
        }
        .message.warning {
            background: #fff8e1;
            color: #f57f17;
            border: 1px solid #ffe082;
        }
        .key-display {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 6px;
            margin: 20px 0;
            border: 1px solid #e0e0e0;
        }
        .key-value {
            font-family: 'Courier New', monospace;
            font-size: 14px;
            word-break: break-all;
            padding: 10px;
            background: white;
            border-radius: 4px;
            margin: 10px 0;
        }
        .keys-list {
            margin-top: 20px;
        }
        .key-item {
            background: #f9f9f9;
            padding: 15px;
            border-radius: 6px;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .key-info {
            flex: 1;
        }
        .key-prefix {
            font-family: 'Courier New', monospace;
            font-size: 13px;
            color: #666;
        }
        .key-meta {
            font-size: 12px;
            color: #999;
            margin-top: 5px;
        }
        .section {
            display: none;
        }
        .section.active {
            display: block;
        }
        .oauth-instructions {
            background: #f0f4ff;
            padding: 15px;
            border-radius: 6px;
            margin: 15px 0;
            border-left: 4px solid #667eea;
        }
        .oauth-instructions ol {
            margin-left: 20px;
            margin-top: 10px;
        }
        .oauth-instructions li {
            margin: 8px 0;
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="header-content">
            <h1>Claude Proxy Dashboard</h1>
            <button class="btn-logout" onclick="logout()">Logout</button>
        </div>
    </div>

    <div class="container">
        <div id="message" class="message"></div>

        <!-- OAuth Connection Section -->
        <div class="card">
            <h2>Claude Pro/Max Connection</h2>
            <div id="oauth-status-section">
                <p>Status: <span id="oauth-status" class="status">Checking...</span></p>
                <div id="connect-section" class="section">
                    <div class="oauth-instructions">
                        <strong>Connect your Claude Pro/Max account:</strong>
                        <ol>
                            <li>Click "Connect Claude Account" button</li>
                            <li>A new window will open with Claude OAuth page</li>
                            <li>Authorize the application</li>
                            <li>Copy the authorization code from the callback page</li>
                            <li>Paste it in the prompt that appears</li>
                        </ol>
                    </div>
                    <button class="btn-primary" onclick="connectClaude()">Connect Claude Account</button>
                </div>
                <div id="connected-section" class="section">
                    <p style="color: #2e7d32; margin: 15px 0;">Your Claude account is connected!</p>
                    <button class="btn-danger" onclick="disconnectClaude()">Disconnect</button>
                </div>
            </div>
        </div>

        <!-- API Key Management Section -->
        <div class="card" id="api-key-section" style="display: none;">
            <h2>API Keys</h2>
            <button class="btn-primary" onclick="generateKey()">Generate New API Key</button>

            <div id="new-key-display" style="display: none;" class="key-display">
                <strong style="color: #c62828;">⚠️ Save this key now - it will only be shown once!</strong>
                <div class="key-value" id="new-key-value"></div>
                <button class="btn-secondary" onclick="copyKey()">Copy to Clipboard</button>
            </div>

            <div class="keys-list">
                <h3 style="margin: 20px 0 10px 0; color: #666; font-size: 16px;">Your API Keys</h3>
                <div id="keys-list-content"></div>
            </div>
        </div>

        <!-- Usage Instructions -->
        <div class="card" id="usage-section" style="display: none;">
            <h2>How to Use Your API Key</h2>
            <p style="margin-bottom: 15px;">Send requests to the proxy endpoint with your API key:</p>
            <div class="key-display">
                <pre style="margin: 0; overflow-x: auto;">curl -X POST http://localhost:3000/v1/messages \
  -H "Authorization: Bearer YOUR_API_KEY" \
  -H "Content-Type: application/json" \
  -d '{
    "model": "claude-sonnet-4-20250514",
    "max_tokens": 1024,
    "messages": [
      {"role": "user", "content": "Hello, Claude!"}
    ]
  }'</pre>
            </div>
        </div>
    </div>

    <script>
        const API_BASE = '';
        let authToken = localStorage.getItem('token');
        let currentVerifier = null;

        if (!authToken) {
            window.location.href = '/';
        }

        async function apiCall(endpoint, options = {}) {
            const response = await fetch(API_BASE + endpoint, {
                ...options,
                headers: {
                    'Authorization': `Bearer ${authToken}`,
                    'Content-Type': 'application/json',
                    ...options.headers
                }
            });

            if (response.status === 401) {
                logout();
                return null;
            }

            return response;
        }

        async function checkOAuthStatus() {
            const response = await apiCall('/api/claude/status');
            const data = await response.json();

            const statusEl = document.getElementById('oauth-status');
            const connectSection = document.getElementById('connect-section');
            const connectedSection = document.getElementById('connected-section');
            const apiKeySection = document.getElementById('api-key-section');
            const usageSection = document.getElementById('usage-section');

            if (data.connected) {
                statusEl.textContent = 'Connected';
                statusEl.className = 'status connected';
                connectSection.classList.remove('active');
                connectedSection.classList.add('active');
                apiKeySection.style.display = 'block';
                usageSection.style.display = 'block';
                loadApiKeys();
            } else {
                statusEl.textContent = 'Not Connected';
                statusEl.className = 'status disconnected';
                connectSection.classList.add('active');
                connectedSection.classList.remove('active');
                apiKeySection.style.display = 'none';
                usageSection.style.display = 'none';
            }
        }

        async function connectClaude() {
            hideMessage();
            try {
                const response = await apiCall('/api/claude/connect');
                const data = await response.json();

                currentVerifier = data.verifier;

                // Open OAuth URL in new window
                window.open(data.url, '_blank');

                // Wait a bit then prompt for code
                setTimeout(() => {
                    const code = prompt('Paste the authorization code from the callback page:');
                    if (code) {
                        exchangeCode(code);
                    }
                }, 2000);
            } catch (error) {
                showMessage('Failed to start OAuth flow', 'error');
            }
        }

        async function exchangeCode(code) {
            if (!currentVerifier) {
                showMessage('OAuth flow not started properly', 'error');
                return;
            }

            try {
                const response = await apiCall('/api/claude/callback', {
                    method: 'POST',
                    body: JSON.stringify({ code, verifier: currentVerifier })
                });

                const data = await response.json();

                if (response.ok) {
                    showMessage('Claude account connected successfully!', 'success');
                    currentVerifier = null;
                    setTimeout(() => checkOAuthStatus(), 1000);
                } else {
                    showMessage(data.error || 'Failed to connect', 'error');
                }
            } catch (error) {
                showMessage('Network error', 'error');
            }
        }

        async function disconnectClaude() {
            if (!confirm('Are you sure you want to disconnect your Claude account? All API keys will stop working.')) {
                return;
            }

            try {
                const response = await apiCall('/api/claude/disconnect', {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showMessage('Claude account disconnected', 'success');
                    setTimeout(() => checkOAuthStatus(), 1000);
                }
            } catch (error) {
                showMessage('Failed to disconnect', 'error');
            }
        }

        async function generateKey() {
            hideMessage();
            document.getElementById('new-key-display').style.display = 'none';

            try {
                const response = await apiCall('/api/keys/generate', {
                    method: 'POST',
                    body: JSON.stringify({})
                });

                const data = await response.json();

                if (response.ok) {
                    document.getElementById('new-key-value').textContent = data.key;
                    document.getElementById('new-key-display').style.display = 'block';
                    loadApiKeys();
                } else {
                    showMessage(data.error || 'Failed to generate key', 'error');
                }
            } catch (error) {
                showMessage('Network error', 'error');
            }
        }

        async function loadApiKeys() {
            try {
                const response = await apiCall('/api/keys/list');
                const data = await response.json();

                const listEl = document.getElementById('keys-list-content');

                if (data.keys.length === 0) {
                    listEl.innerHTML = '<p style="color: #999;">No API keys yet. Generate one to get started!</p>';
                    return;
                }

                listEl.innerHTML = data.keys.map(key => `
                    <div class="key-item">
                        <div class="key-info">
                            <div class="key-prefix">${key.prefix}</div>
                            <div class="key-meta">
                                Created: ${new Date(key.created_at * 1000).toLocaleDateString()}
                                ${key.is_active ? '<span style="color: #2e7d32;">● Active</span>' : '<span style="color: #999;">● Inactive</span>'}
                            </div>
                        </div>
                        <button class="btn-danger" onclick="deleteKey('${key.id}')">Delete</button>
                    </div>
                `).join('');
            } catch (error) {
                console.error('Failed to load keys', error);
            }
        }

        async function deleteKey(keyId) {
            if (!confirm('Are you sure you want to delete this API key?')) {
                return;
            }

            try {
                const response = await apiCall(`/api/keys/${keyId}`, {
                    method: 'DELETE'
                });

                if (response.ok) {
                    showMessage('API key deleted', 'success');
                    loadApiKeys();
                }
            } catch (error) {
                showMessage('Failed to delete key', 'error');
            }
        }

        function copyKey() {
            const keyValue = document.getElementById('new-key-value').textContent;
            navigator.clipboard.writeText(keyValue);
            showMessage('API key copied to clipboard!', 'success');
        }

        function showMessage(text, type) {
            const msg = document.getElementById('message');
            msg.textContent = text;
            msg.className = 'message ' + type;
            msg.style.display = 'block';
            setTimeout(() => hideMessage(), 5000);
        }

        function hideMessage() {
            document.getElementById('message').style.display = 'none';
        }

        function logout() {
            localStorage.removeItem('token');
            window.location.href = '/';
        }

        // Initialize
        checkOAuthStatus();
    </script>
</body>
</html>
